#!/bin/sh
@SHELLOPTIONS@
#
# This file is released under the terms of the Artistic License.  Please see
# the file LICENSE, included in this package, for details.
#
# Copyright The DBT-3 Authors

usage()
{
	echo "usage: $(basename "${0}") -i <q_time.csv> -s <SCALE_FACTOR>"
}

while getopts "hi:s:" opt; do
	case "${opt}" in
	h)
		usage
		exit 1
		;;
	i)
		INFILE=$OPTARG
		;;
	s)
		SCALE_FACTOR=$OPTARG
		;;
	\?)
		usage
		exit 1
		;;
	esac
done

TMPDIR=$(mktemp -d)
DBFILE="${TMPDIR}/dbt3.db"
sqlite3 "${DBFILE}" << EOF
CREATE TABLE qtime(
    task_name TEXT
  , s_time TEXT
  , e_time TEXT
  , diff_time REAL
  , seconds INTEGER
);
.mode csv
.import ${INFILE} qtime
SELECT 3600.0
     * $SCALE_FACTOR
     / pow(exp(sum(ln(coalesce(seconds, 1)))),
           1.0 / (SELECT count(*)
                  FROM qtime
                  WHERE task_name LIKE 'PERF.POWER.Q%'
                  OR task_name LIKE 'PERF.POWER.RF%'))
FROM qtime
WHERE task_name LIKE 'PERF.POWER.Q%'
   OR task_name LIKE 'PERF.POWER.RF%';
EOF

rm -rf "${TMPDIR}"
